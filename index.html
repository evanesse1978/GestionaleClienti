<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Clienti Personali</title>
    <style>
        :root {
            --primary-color: #4A90E2; --primary-dark: #357ABD; --secondary-color: #F4F7F9;
            --surface-color: #FFFFFF; --border-color: #EAECEF; --text-color: #333D47;
            --text-light: #7A8C99; --status-paid: #E7F5E8; --status-warning: #FFFBEA; 
            --status-danger: #FDECEA; --status-suspended: #EAF2FA; --birthday-bg: #fff9c4;
            --neumorphic-bg: #eef2f7; --neumorphic-shadow-light: #ffffff; --neumorphic-shadow-dark: #d1d9e6;
        }
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@700&display=swap');
        
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--text-color); }
        .padding-24 { padding: 24px; }
        .container { max-width: 1800px; margin: 0 auto; background-color: var(--surface-color); padding: 32px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header-section { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border-color); padding-bottom: 16px; margin-bottom: 24px; }
        h1, h2, h3 { color: var(--primary-color); margin-top: 0; font-weight: 700; }
        h2, h3 { color: var(--text-color); font-weight: 500;}

        /* Stile Pagina Iniziale */
        #landing-page {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Centra verticalmente il box di login */
            align-items: center;
            min-height: 100vh;
            text-align: center;
            background-color: var(--neumorphic-bg);
            padding: 40px 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        #landing-page-top-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        #landing-page h1 {
            font-family: 'Exo 2', sans-serif;
            font-size: 4.5em; 
            font-weight: 700;
            color: #4a5a6a;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 40px; 
            text-shadow: 
                2px 2px 0px var(--neumorphic-shadow-dark),
                -2px -2px 0px var(--neumorphic-shadow-light),
                4px 4px 8px rgba(0,0,0,0.2);
        }
        
        .top-right-buttons {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .landing-buttons { 
            margin-top: 20px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 50px; 
        }
        
        .landing-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #555;
            border: none;
            border-radius: 30px; 
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background-color: var(--neumorphic-bg);
            box-shadow: 
                8px 8px 16px var(--neumorphic-shadow-dark), 
                -8px -8px 16px var(--neumorphic-shadow-light);
            width: 280px; 
            height: 220px; 
            font-size: 1.8em; 
        }
        
        .landing-btn:hover {
            transform: translateY(-5px) scale(1.02);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .backup-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #444;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 
                -3px -3px 7px rgba(255,255,255,0.7), 
                3px 3px 5px rgba(94,104,121,0.3);
            width: auto;
            padding: 12px 20px;
            font-size: 1em;
            background: linear-gradient(145deg, #8ad38a, #62c462);
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .backup-btn:hover {
            box-shadow: 
                inset -2px -2px 5px rgba(255,255,255,0.7), 
                inset 2px 2px 4px rgba(94,104,121,0.3);
            transform: translateY(2px);
            color: #fff;
        }
        
        .landing-btn .icon { 
            font-size: 3.5em; 
            margin-bottom: 20px; 
            filter: drop-shadow(3px 3px 4px rgba(0,0,0,0.15));
            transition: transform 0.3s ease;
        }

        .landing-btn:hover .icon {
            transform: scale(1.1);
        }

        #birthday-notifications { background-color: var(--birthday-bg); border-left: 5px solid #FBC02D; padding: 16px; margin-top: 40px; border-radius: 5px; width: 80%; max-width: 600px; text-align: left; }
        .birthday-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #FFFDE7; }
        
        .cf-utility-container {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            margin-bottom: 20px;
            background: var(--neumorphic-bg);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 
                8px 8px 16px var(--neumorphic-shadow-dark), 
                -8px -8px 16px var(--neumorphic-shadow-light);
        }
        .cf-utility-container h3 {
             font-family: 'Exo 2', sans-serif;
             color: #388e3c;
             margin-bottom: 10px;
        }
        .cf-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cf-tab-btn {
            padding: 6px 12px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 8px;
            cursor: pointer;
            background-color: #c8e6c9;
            font-family: 'Roboto', sans-serif;
            transition: all 0.2s;
        }
        .cf-tab-btn.active {
            background-color: #4caf50;
            color: white;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.2);
        }
        .cf-panel { display: none; }
        .cf-panel.active { display: block; }
        .cf-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            align-items: center;
        }
        .cf-form input, .cf-form select {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            padding: 6px;
        }
        .cf-result {
            margin-top: 10px;
            padding: 8px;
            background-color: #fff;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-weight: bold;
            text-align: center;
            min-height: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #cf-copy-btn {
            padding: 2px 8px;
            font-size: 0.8em;
            margin-left: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        /* Login/Register Box */
        #auth-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #auth-container h3 {
            margin-top: 0;
            text-align: center;
            color: #4a5a6a;
        }
        #auth-container input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
        }
        #auth-container #submit-auth-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #auth-container #submit-auth-btn:hover {
            background-color: var(--primary-dark);
        }
        #switch-auth-mode {
            font-size: 0.9em;
            color: #555;
            cursor: pointer;
            text-align: center;
        }
        #switch-auth-mode a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }


        /* App Sections */
        #main-app, #client-archive { display: none; }

        /* Client Archive Styles */
        .archive-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .archive-filters { display: flex; gap: 15px; margin-bottom: 20px; background-color: var(--secondary-color); padding: 16px; border-radius: 8px; align-items: center; }
        .archive-filters input { width: 300px; }
        .client-list .client-item { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .client-header { padding: 15px; background-color: var(--secondary-color); font-weight: 500; }
        .client-info-grid { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 15px; }
        .client-data-fields { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px 15px; }
        .client-data-fields span, .client-data-fields input { padding: 5px; border-radius: 4px; }
        .client-data-fields input { border: 1px solid var(--primary-color); background: white; }
        .client-actions { display: flex; gap: 5px; }
        .client-actions button { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        .client-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .client-controls .expander, .client-controls .add-title-btn { cursor: pointer; padding: 5px 10px; border-radius: 5px; }
        .client-controls .expander { background-color: #e0eaf3; }
        .client-controls .add-title-btn { background-color: var(--primary-color); color: white; }
        
        .client-details, .policy-details { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .policy-item { border-top: 1px dashed var(--border-color); }
        .policy-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; margin: 5px 0; flex-wrap: wrap; gap: 10px;}
        .policy-header:hover { filter: brightness(95%); }
        .title-list { padding-left: 15px; padding-bottom: 10px; }
        .title-item { padding: 8px; border-top: 1px solid #f1f1f1; display: grid; grid-template-columns: repeat(4, 1fr) auto; align-items: center; gap: 10px; border-radius: 4px; }
        .title-item:hover { background-color: #f0f4f8; }
        .title-item button { font-size: 1.2em; background: transparent; border: none; padding: 5px; cursor: pointer; }
        .ramo-auto { background-color: #e3f2fd; border-left: 4px solid #2196F3; }
        .ramo-rami-vari { background-color: #e8f5e9; border-left: 4px solid #4CAF50; }
        .ramo-vita { background-color: #fffde7; border-left: 4px solid #FFC107; }

        /* Generic Styles */
        .controls-container { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .all-filters-container { display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end; }
        .filters-group { border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; }
        .filters-group legend { font-weight: 500; font-size: 0.9em; color: var(--primary-color); padding: 0 5px; }
        select, button, input { padding: 9px 14px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--surface-color); font-size: 0.9em; font-family: 'Roboto', sans-serif; transition: all 0.2s ease; }
        button { cursor: pointer; background-color: #fff; color: var(--primary-color); font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        button:hover { border-color: var(--primary-color); background-color: var(--primary-color); color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.2); }
        form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; background-color: var(--secondary-color); padding: 24px; border-radius: 8px; align-items: end; }
        .form-field label { display: block; margin-bottom: 6px; font-size: 0.9em; font-weight: 500; color: var(--text-light); }
        .form-submit-button { background-color: var(--primary-color); color: white; font-size: 1.1em; grid-column: 1 / -1; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--secondary-color); color: var(--text-light); font-weight: 500; text-transform: uppercase; font-size: 0.8em; }
        .summary { margin-bottom: 20px; padding: 16px; background-color: #eaf2fa; border-left: 5px solid var(--primary-color); font-size: 1.1em; font-weight: 500; border-radius: 5px; }
        .status-paid { background-color: var(--status-paid); } .status-warning { background-color: var(--status-warning); } .status-danger { background-color: var(--status-danger); } .status-suspended { background-color: var(--status-suspended); } .status-annullata { text-decoration: line-through; opacity: 0.5; }
        .action-cell { display: flex; gap: 5px; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 400px; }
        
        /* --- Stili Stampa --- */
        @media print {
            @page {
                size: A4 landscape;
                margin: 1.5cm;
            }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 10pt; background-color: #fff; }
            body > *:not(#main-app) { display: none; }
            #main-app { display: block !important; }
            #main-app .container { box-shadow: none; border: none; padding: 0; margin: 0; max-width: 100%; }
            #print-header { display: block !important; font-size: 24pt; font-weight: bold; text-align: center; margin-bottom: 20px; color: black; }
            .header-section, .controls-container, #client-form, #form-title, h2 { display: none !important; }
            
            /* RIPRISTINO TABELLA PER LA STAMPA */
            #main-app table { display: table !important; }
            #main-app table thead { display: table-header-group !important; }
            #main-app table tbody { display: table-row-group !important; }
            #main-app table tr { display: table-row !important; }
            #main-app table th, #main-app table td { display: table-cell !important; padding: 6px; border: 1px solid #666;}
            #main-app table td::before { content: "" !important; display: none !important; }
            
            /* NASCONDI COLONNA AZIONI IN STAMPA */
            table th:last-child, table td:last-child { display: none !important; }
            
            .summary { text-align: right; border: 1px solid #ccc; background-color: #f0f0f0 !important; }
            th { background-color: #ddd !important; }
            tr.status-paid { background-color: #e7f5e8 !important; }
            tr.status-warning { background-color: #fffbea !important; }
            tr.status-danger { background-color: #fdecea !important; }
            tr.status-suspended { background-color: #eaf2fa !important; }
            tr.status-annullata { text-decoration: line-through; opacity: 0.7; }
        }

        /* --- Stili Responsivi --- */
        @media (max-width: 1200px) {
            .container { padding: 24px; }
            .landing-buttons { gap: 30px; }
            .landing-btn { width: 240px; height: 180px; font-size: 1.5em; }
        }

        /* Tablet, Foldable e Smartphone Grandi */
        @media (max-width: 992px) {
            #landing-page h1 { font-size: 3em; }
            .landing-buttons { grid-template-columns: 1fr; gap: 20px; }
            .landing-btn { width: 100%; max-width: 350px; height: 150px; }

            /* Trasforma la tabella in schede */
            #main-app table thead { display: none; }
            #main-app table, #main-app table tbody, #main-app table tr, #main-app table td { display: block; width: 100%; }
            #main-app table tr { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            
            /* OTTIMIZZAZIONE VISTA SCHEDE */
            #main-app table td {
                display: flex;
                justify-content: flex-start; /* Allinea a sinistra */
                align-items: center;
                gap: 10px; /* Spazio tra etichetta e valore */
                padding: 12px 15px;
                text-align: left; /* Allinea il testo del valore a sinistra */
                border-bottom: 1px dotted var(--border-color);
                flex-wrap: wrap; /* Permette al contenuto di andare a capo */
            }
            #main-app table td:last-child { border-bottom: none; }
            #main-app table td::before {
                content: attr(data-label);
                font-weight: 500;
                color: var(--text-light);
                flex-basis: 110px; /* Larghezza fissa per le etichette */
                flex-shrink: 0; /* Impedisce alle etichette di rimpicciolirsi */
                text-align: left;
            }
            
            td .inline-editable { width: 100px; text-align: right; }
            .action-cell { flex-wrap: nowrap; justify-content: flex-end; }
        }

        /* Smartphone Piccoli e Medi */
        @media (max-width: 767px) {
            .padding-24 { padding: 12px; }
            .container { padding: 16px; }
            .header-section { flex-direction: column; align-items: flex-start; gap: 15px; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            #landing-page h1 { font-size: 2.2em; margin-bottom: 30px; }
            
            /* NASCONDI ELEMENTI SU MOBILE */
            #export-btn, #import-btn, .cf-utility-container {
                display: none !important;
            }

            .all-filters-container, .actions, .archive-filters { flex-direction: column; align-items: stretch; width: 100%; }
            .filters-group { width: auto; }
            .archive-filters input { width: 100%; box-sizing: border-box; }
            #client-form { grid-template-columns: 1fr; }
            .client-info-grid, .client-data-fields { grid-template-columns: 1fr; }
            .client-controls { flex-direction: column; gap: 10px; align-items: stretch; text-align: center; }
        }

    </style>
</head>
<body>
    <div id="landing-page">
        <div class="top-right-buttons" style="display: none;">
            <button id="export-btn" class="backup-btn">Esporta JSON</button>
            <button id="import-btn" class="backup-btn">Importa JSON</button>
            <button id="logout-btn" class="backup-btn" style="background: #f44336;">Logout</button>
        </div>
        
        <div id="landing-page-content" style="width:100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h1 id="main-title">Gestionale Clienti</h1>
            
            <div id="auth-container">
                <h3 id="auth-title">Accedi</h3>
                <input type="email" id="email-input" placeholder="Email" autocomplete="email">
                <input type="password" id="password-input" placeholder="Password" autocomplete="current-password">
                <button id="submit-auth-btn">Accedi</button>
                <p id="auth-error" style="color: red; min-height: 1.2em; margin: 0;"></p>
                <p id="switch-auth-mode">Non hai un account? <a href="#">Registrati</a></p>
            </div>

            <div class="landing-buttons" style="display: none;">
                <button id="goto-main-app" class="landing-btn"><div class="icon">üõ°Ô∏è</div>Gestionale Polizze</button>
                <button id="goto-client-archive" class="landing-btn"><div class="icon">üóÇÔ∏è</div>Archivio Clienti</button>
            </div>

            <div id="birthday-notifications" style="display: none;"></div>
       
            <div class="cf-utility-container" style="display: none;">
                <h3>Utility Codice Fiscale</h3>
                <div class="cf-tabs">
                    <button id="tab-btn-calc" class="cf-tab-btn active">Calcola CF</button>
                    <button id="tab-btn-rev" class="cf-tab-btn">Analizza CF</button>
                </div>
                <div id="cf-calc-panel" class="cf-panel active">
                    <div class="cf-form">
                        <input type="text" id="cf-cognome" placeholder="Cognome">
                        <input type="text" id="cf-nome" placeholder="Nome">
                        <input type="date" id="cf-data" placeholder="Data di Nascita">
                        <select id="cf-sesso"><option value="M">Maschio</option><option value="F">Femmina</option></select>
                        <input type="text" id="cf-comune" placeholder="Comune di Nascita (es: ROMA)">
                    </div>
                    <button id="calculate-cf-btn" style="margin-top: 10px;">Calcola</button>
                    <div id="cf-result-calc" class="cf-result">
                        <span id="cf-result-text"></span>
                        <button id="cf-copy-btn" title="Copia Codice" style="display: none;">COPIA</button>
                    </div>
                </div>
                <div id="cf-rev-panel" class="cf-panel">
                    <div class="cf-form">
                        <input type="text" id="cf-inverso-input" placeholder="Inserisci Codice Fiscale" maxlength="16" style="grid-column: 1 / -1;">
                    </div>
                    <button id="reverse-cf-btn" style="margin-top: 10px;">Analizza</button>
                    <div id="cf-result-rev" class="cf-result"></div>
                </div>
            </div>
        </div>
        <input type="file" id="import-file" accept=".json" style="display: none;">
    </div>
    <div id="main-app" class="padding-24">
        <div class="container">
            <div class="header-section">
                <h1>Gestionale Polizze</h1>
                 <button id="back-to-landing-1">‚¨ÖÔ∏è Torna al menu</button>
            </div>
            <div id="print-header" style="display: none;"></div>
            <div class="controls-container">
                 <div class="all-filters-container">
                    <fieldset class="filters-group"> <legend>Filtra Stato</legend> <select id="filter-status"><option value="attiva">Attive</option><option value="sospesa">Sospese</option><option value="annullata">Annullate</option><option value="all">Tutte</option></select> <select id="filter-paid"><option value="all">Tutti</option><option value="paid">Pagati</option><option value="unpaid">Da Pagare</option></select> </fieldset>
                    <fieldset class="filters-group"> <legend>Filtri Scadenza</legend> <select id="filter-year"><option value="all">Anno</option></select><select id="filter-month"><option value="all">Mese</option></select> </fieldset>
                    <fieldset class="filters-group"> <legend>Filtri Incasso</legend> <select id="filter-incasso-year"><option value="all">Anno</option></select><select id="filter-incasso-month"><option value="all">Mese</option></select> </fieldset>
                </div>
                <div class="actions">
                    <button id="renew-btn" title="Crea rinnovi">Crea Rinnovi</button>
                    <button id="sort-button">Ordina Scadenza</button>
                    <button onclick="printCustom()" title="Stampa">üñ®Ô∏è</button>
                </div>
            </div>
            <h2 id="form-title">Aggiungi / Modifica Titolo</h2>
            <form id="client-form"></form>
            <h2>Archivio Polizze</h2>
            <div class="summary" id="summary"></div>
            <table>
                 <thead>
                    <tr><th>Pagato</th><th>Ann.</th><th>Nome Cliente</th><th>Compagnia</th><th>N. Polizza</th><th>Ramo</th><th>Tipo</th><th>Scadenza</th><th>Stato</th><th>Fraz.</th><th>Data Incasso</th><th>Premio (‚Ç¨)</th><th>Diff. (‚Ç¨)</th><th>Provv. (‚Ç¨)</th><th>Azioni</th></tr>
                </thead>
                <tbody id="clients-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="client-archive" class="padding-24">
        <div class="container">
            <div class="archive-header">
                <h2>Archivio Clienti</h2>
                <div>
                    <button id="add-new-client-btn" style="margin-right: 15px;">+ Aggiungi Nuova Anagrafica</button>
                    <button id="back-to-landing-2">‚¨ÖÔ∏è Torna al menu</button>
                </div>
            </div>
            <div class="archive-filters">
                <input type="text" id="search-name" placeholder="Cerca per Nome Cliente...">
                <input type="text" id="search-cf" placeholder="Cerca per Codice Fiscale / P.IVA...">
                <button id="apply-client-filter-btn">Applica Filtro</button>
            </div>
            <div id="client-list-container" class="client-list"></div>
        </div>
    </div>

    <div id="choice-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Scegli il metodo di invio</h3>
            <p>Come desideri inviare gli auguri?</p>
            <div class="modal-buttons"> <button id="modal-btn-email">üìß Via Email</button> <button id="modal-btn-whatsapp">üì± Via WhatsApp</button> <button id="modal-btn-cancel">Annulla</button> </div>
        </div>
    </div>

    <!-- Script Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // Configurazione Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDhhNoGXZdAMHdGgqUNGrVl1JtuErcOhe4",
        authDomain: "gestionaleclienti-696e8.firebaseapp.com",
        projectId: "gestionaleclienti-696e8",
        storageBucket: "gestionaleclienti-696e8.firebasestorage.app",
        messagingSenderId: "301458283825",
        appId: "1:301458283825:web:8d6ed6a8d5ca9fae842410"
    };

    // Inizializzazione Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null; 
    let isLoginMode = true;

    // ELEMENTI UI DA GESTIRE
    const authContainer = document.getElementById('auth-container');
    const landingButtons = document.querySelector('.landing-buttons');
    const topRightButtons = document.querySelector('.top-right-buttons');
    const submitAuthBtn = document.getElementById('submit-auth-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const authError = document.getElementById('auth-error');
    const switchAuthModeLink = document.getElementById('switch-auth-mode');
    const authTitle = document.getElementById('auth-title');
    const cfUtilityContainer = document.querySelector('.cf-utility-container');
    const mainTitle = document.getElementById('main-title');
    const birthdayNotifications = document.getElementById('birthday-notifications');

    // Listener per lo stato di autenticazione
    auth.onAuthStateChanged(user => {
        if (user) {
            // Utente LOGGATO
            currentUser = user;
            authContainer.style.display = 'none';
            mainTitle.style.display = 'block';
            landingButtons.style.display = 'grid';
            topRightButtons.style.display = 'flex';
            cfUtilityContainer.style.display = 'block';
            birthdayNotifications.style.display = 'block';
            
            console.log("Utente autenticato, carico i dati da Firestore...");
            const userDocRef = db.collection('clienti').doc(currentUser.uid);
            userDocRef.get().then(doc => {
                if (doc.exists) {
                    try {
                        clients = JSON.parse(doc.data().data);
                        console.log("Dati recuperati con successo da Firebase.");
                    } catch (e) {
                         console.error("Errore nel parsing dei dati da Firebase:", e);
                         clients = [];
                    }
                } else {
                    console.log("Nessun dato precedente. Inizio con un database vuoto.");
                    clients = [];
                }
                renderBirthdayNotifications();
                if(mainAppPage.style.display === 'block') renderTable();
                if(clientArchivePage.style.display === 'block') renderClientArchive();
            }).catch(error => {
                console.error("Errore nel recupero dati da Firestore: ", error);
                alert("Errore critico: impossibile caricare i dati.");
            });
        } else {
            // Utente NON LOGGATO
            currentUser = null;
            clients = [];
            authContainer.style.display = 'flex';
            mainTitle.style.display = 'none';
            landingButtons.style.display = 'none';
            topRightButtons.style.display = 'none';
            cfUtilityContainer.style.display = 'none';
            birthdayNotifications.style.display = 'none';
            showPage(landingPage);
            console.log("Utente non autenticato.");
        }
    });
    
    const toggleAuthMode = () => {
        isLoginMode = !isLoginMode;
        authError.textContent = '';
        if (isLoginMode) {
            authTitle.textContent = 'Accedi';
            submitAuthBtn.textContent = 'Accedi';
            switchAuthModeLink.innerHTML = 'Non hai un account? <a href="#">Registrati</a>';
        } else {
            authTitle.textContent = 'Registrati';
            submitAuthBtn.textContent = 'Registrati';
            switchAuthModeLink.innerHTML = 'Hai gi√† un account? <a href="#">Accedi</a>';
        }
    };

    switchAuthModeLink.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthMode();
    });

    submitAuthBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';

        if (!email || !password) {
            authError.textContent = 'Inserire email e password.';
            return;
        }

        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Errore di login:", error.code, error.message);
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                         authError.textContent = 'Credenziali non valide.';
                    } else {
                         authError.textContent = 'Errore di autenticazione.';
                    }
                });
        } else {
            if (password.length < 6) {
                authError.textContent = 'La password deve essere di almeno 6 caratteri.';
                return;
            }
            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Errore di registrazione:", error.code, error.message);
                    if (error.code === 'auth/email-already-in-use') {
                        authError.textContent = 'Questa email √® gi√† registrata.';
                    } else if (error.code === 'auth/invalid-email') {
                        authError.textContent = 'Email non valida.';
                    } else {
                        authError.textContent = 'Errore di registrazione.';
                    }
                });
        }
    });

    logoutBtn.addEventListener('click', () => {
         auth.signOut();
    });

    //<editor-fold desc="Variabili Globali e Funzioni Pagine">
    let clients = []; 
    let isSortedAsc = true;
    let comuniData = null; 
    
    const landingPage = document.getElementById('landing-page');
    const mainAppPage = document.getElementById('main-app');
    const clientArchivePage = document.getElementById('client-archive');

    const showPage = (pageToShow) => {
        landingPage.style.display = 'none';
        mainAppPage.style.display = 'none';
        clientArchivePage.style.display = 'none';
        pageToShow.style.display = 'flex';
        if (pageToShow !== landingPage) {
            pageToShow.style.display = 'block';
        }
    };
    //</editor-fold>

    //<editor-fold desc="Logica Utility Codice Fiscale">
    async function loadComuni() {
        if (comuniData) return;
        try {
            const response = await fetch('https://raw.githubusercontent.com/matteocontrini/comuni-json/master/comuni.json');
            if (!response.ok) throw new Error('Network response was not ok');
            comuniData = await response.json();
        } catch (error) {
            console.error("Impossibile caricare i dati dei comuni:", error);
            alert("Errore: impossibile caricare l'elenco dei comuni. Il calcolo del CF non funzioner√† correttamente.");
        }
    }

    function calculateCF() {
        const resultText = document.getElementById('cf-result-text');
        const copyBtn = document.getElementById('cf-copy-btn');
        copyBtn.style.display = 'none';

        if (!comuniData) {
            resultText.textContent = "Dati dei comuni non ancora caricati. Riprova.";
            return;
        }

        const cognome = document.getElementById('cf-cognome').value.trim().toUpperCase();
        const nome = document.getElementById('cf-nome').value.trim().toUpperCase();
        const data = document.getElementById('cf-data').value;
        const sesso = document.getElementById('cf-sesso').value;
        const comune = document.getElementById('cf-comune').value.trim().toUpperCase();
        
        if (!cognome || !nome || !data || !comune) {
            resultText.textContent = "Tutti i campi sono obbligatori.";
            return;
        }

        const cognomeCode = getCognomeCode(cognome);
        const nomeCode = getNomeCode(nome);
        const dateCode = getDateCode(data, sesso);
        const comuneCode = getComuneCode(comune);

        if (!comuneCode) {
            resultText.textContent = "Comune non trovato. Inserire il nome corretto (es: ROMA).";
            return;
        }

        const partialCF = cognomeCode + nomeCode + dateCode + comuneCode;
        const controlChar = getControlChar(partialCF);
        
        resultText.textContent = partialCF + controlChar;
        copyBtn.style.display = 'inline-block';
    }
    
    function copyCF() {
        const cfText = document.getElementById('cf-result-text').textContent;
        if(navigator.clipboard && cfText) {
            navigator.clipboard.writeText(cfText).then(() => {
                alert('Codice Fiscale copiato!');
            }, (err) => {
                alert('Errore durante la copia.');
            });
        }
    }

    function reverseCF() {
        if (!comuniData) {
            alert("Dati dei comuni non ancora caricati. Riprova tra un istante.");
            return;
        }

        const cf = document.getElementById('cf-inverso-input').value.trim().toUpperCase();
        const resultDiv = document.getElementById('cf-result-rev');
        
        if (cf.length !== 16) {
            resultDiv.textContent = "Il Codice Fiscale deve essere di 16 caratteri.";
            return;
        }
        
        const yearStr = cf.substring(6, 8);
        const monthChar = cf.substring(8, 9);
        const dayStr = cf.substring(9, 11);
        const comuneCode = cf.substring(11, 15);
        
        let day = parseInt(dayStr, 10);
        const sesso = (day > 40) ? "Femmina" : "Maschio";
        if (day > 40) day -= 40;

        const monthMap = {'A':0, 'B':1, 'C':2, 'D':3, 'E':4, 'H':5, 'L':6, 'M':7, 'P':8, 'R':9, 'S':10, 'T':11};
        const month = monthMap[monthChar];

        const currentYear = new Date().getFullYear() % 100;
        let year = parseInt(yearStr, 10);
        year += (year > currentYear) ? 1900 : 2000;
        
        const comune = comuniData.find(c => c.codiceCatastale === comuneCode);

        if (isNaN(day) || month === undefined || isNaN(year) || !comune) {
             resultDiv.textContent = "Codice Fiscale non valido o dati non interpretabili.";
             return;
        }

        resultDiv.textContent = `Sesso: ${sesso}, Nato/a il: ${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year}, Comune: ${comune.nome}`;
    }

    function getVowels(str) { return str.replace(/[^AEIOU]/gi, ""); }
    function getConsonants(str) { return str.replace(/[^BCDFGHJKLMNPQRSTVWXYZ]/gi, ""); }

    function getCognomeCode(cognome) {
        const cons = getConsonants(cognome);
        const vows = getVowels(cognome);
        let code = (cons + vows + "XXX").substring(0, 3);
        return code;
    }
    
    function getNomeCode(nome) {
        let cons = getConsonants(nome);
        if (cons.length >= 4) {
            return cons[0] + cons[2] + cons[3];
        } else {
            const vows = getVowels(nome);
            return (cons + vows + "XXX").substring(0, 3);
        }
    }

    function getDateCode(data, sesso) {
        const date = new Date(data);
        const year = String(date.getFullYear()).slice(-2);
        const month = "ABCDEHLMPRST"[date.getMonth()];
        let day = date.getDate();
        if (sesso === 'F') {
            day += 40;
        }
        return year + month + String(day).padStart(2, '0');
    }

    function getComuneCode(comuneName) {
        const comune = comuniData.find(c => c.nome.toUpperCase() === comuneName);
        return comune ? comune.codiceCatastale : null;
    }

    function getControlChar(partialCF) {
        let val = 0;
        const evenMap = {0:0, 1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, A:0, B:1, C:2, D:3, E:4, F:5, G:6, H:7, I:8, J:9, K:10, L:11, M:12, N:13, O:14, P:15, Q:16, R:17, S:18, T:19, U:20, V:21, W:22, X:23, Y:24, Z:25};
        const oddMap = {0:1, 1:0, 2:5, 3:7, 4:9, 5:13, 6:15, 7:17, 8:19, 9:21, A:1, B:0, C:5, D:7, E:9, F:13, G:15, H:17, I:19, J:21, K:2, L:4, M:18, N:20, O:11, P:3, Q:6, R:8, S:12, T:14, U:16, V:10, W:22, X:25, Y:24, Z:23};
        
        for (let i = 0; i < 15; i++) {
            const c = partialCF[i];
            if ((i + 1) % 2 === 0) {
                val += evenMap[c];
            } else {
                val += oddMap[c];
            }
        }
        return "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[val % 26];
    }
    //</editor-fold>

    //<editor-fold desc="Archivio Clienti">
    const renderClientArchive = () => {
        const container = document.getElementById('client-list-container');
        const searchName = document.getElementById('search-name').value.toLowerCase();
        const searchCf = document.getElementById('search-cf').value.toLowerCase();
        
        const openForm = document.getElementById('new-client-form');
        if (openForm) openForm.remove();
        
        const uniqueClients = new Map();
        clients.forEach(c => { 
            const name = c.nomeCliente.trim(); 
            uniqueClients.set(name, {
                nomeCliente: name, 
                email: c.email || '', 
                cellulare: c.cellulare || '', 
                codiceFiscale: c.codiceFiscale || '',
                linkedProfiles: c.linkedProfiles || '' 
            });
        });

        let filtered = Array.from(uniqueClients.values()).filter(c => 
            c.nomeCliente.toLowerCase().includes(searchName) && 
            c.codiceFiscale.toLowerCase().includes(searchCf)
        ).sort((a,b)=>a.nomeCliente.localeCompare(b.nomeCliente));

        if (filtered.length === 0) { 
            container.innerHTML = '<p style="text-align:center;">Nessun cliente trovato.</p>'; 
            return; 
        }
        
        container.innerHTML = filtered.map(c => {
            const safeName = c.nomeCliente.replace(/'/g, "\\'");
            return `
            <div class="client-item" data-original-name="${safeName}">
                <div class="client-header">
                    <div class="client-info-grid">
                        <div class="client-data-fields">
                            <span><b>Nome:</b> ${c.nomeCliente}</span>
                            <span><b>CF/P.IVA:</b> ${c.codiceFiscale}</span>
                            <span><b>Cell:</b> ${c.cellulare}</span>
                            <span><b>Email:</b> ${c.email}</span>
                            <span style="grid-column: 1 / -1;"><b>Legami:</b> ${c.linkedProfiles || 'Nessuno'}</span>
                        </div>
                        <div class="client-actions">
                            <button onclick="toggleClientEditMode('${safeName}')" title="Modifica">‚úèÔ∏è</button>
                            <button onclick="deleteClientAnagrafica('${safeName}')" title="Elimina Anagrafica">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="client-controls">
                        <div class="add-title-btn" onclick="prepareNewTitleForClient('${safeName}')">+ Aggiungi Titolo</div>
                        <div class="expander" onclick="toggleClientDetails(this, '${safeName}')">Apri Polizze ‚ñæ</div>
                    </div>
                </div>
                <div class="client-details"></div>
            </div>`;
        }).join('');
    };

    const toggleClientEditMode = (clientName) => {
        const safeName = clientName.replace(/'/g, "\\'");
        const clientItem = document.querySelector(`.client-item[data-original-name='${safeName}']`);
        const fieldsContainer = clientItem.querySelector('.client-data-fields');
        const actionsContainer = clientItem.querySelector('.client-actions');
        
        const clientData = clients.find(c => c.nomeCliente === clientName);
        const currentData = {
            nomeCliente: clientData.nomeCliente,
            codiceFiscale: clientData.codiceFiscale || '',
            cellulare: clientData.cellulare || '',
            email: clientData.email || '',
            linkedProfiles: clientData.linkedProfiles || ''
        };

        fieldsContainer.innerHTML = `
            <input type="text" id="edit-nomeCliente-${safeName}" value="${currentData.nomeCliente}" placeholder="Nome Cliente">
            <input type="text" id="edit-codiceFiscale-${safeName}" value="${currentData.codiceFiscale}" placeholder="CF / P.IVA">
            <input type="tel" id="edit-cellulare-${safeName}" value="${currentData.cellulare}" placeholder="Cellulare">
            <input type="email" id="edit-email-${safeName}" value="${currentData.email}" placeholder="Email">
            <input type="text" id="edit-linkedProfiles-${safeName}" value="${currentData.linkedProfiles}" placeholder="Es: Moglie di Mario Rossi" style="grid-column: 1 / -1;">
        `;
        actionsContainer.innerHTML = `<button onclick="saveClientInfo('${safeName}')" title="Salva">üíæ</button>`;
    };
    
    const saveClientInfo = (originalName) => {
        const safeName = originalName.replace(/'/g, "\\'");
        const newData = {
            nomeCliente: document.getElementById(`edit-nomeCliente-${safeName}`).value.trim(),
            codiceFiscale: document.getElementById(`edit-codiceFiscale-${safeName}`).value.toUpperCase().trim(),
            cellulare: document.getElementById(`edit-cellulare-${safeName}`).value.trim(),
            email: document.getElementById(`edit-email-${safeName}`).value.trim(),
            linkedProfiles: document.getElementById(`edit-linkedProfiles-${safeName}`).value.trim()
        };

        if (!newData.nomeCliente) {
            alert("Il campo Nome Cliente √® obbligatorio.");
            return;
        }

        let changed = false;
        clients.forEach(client => {
            if (client.nomeCliente === originalName) {
                client.nomeCliente = newData.nomeCliente;
                client.codiceFiscale = newData.codiceFiscale;
                client.cellulare = newData.cellulare;
                client.email = newData.email;
                client.linkedProfiles = newData.linkedProfiles;
                changed = true;
            }
        });

        if (changed) {
            saveClients();
            alert('Dati anagrafici aggiornati con successo!');
            renderClientArchive();
        }
    };
    
    const deleteClientAnagrafica = (clientName) => {
        if (confirm(`Sei sicuro di voler eliminare l'anagrafica di "${clientName}"? Verranno rimosse anche TUTTE le polizze associate. L'azione √® irreversibile.`)) {
            const originalLength = clients.length;
            clients = clients.filter(c => c.nomeCliente !== clientName);
            if (clients.length < originalLength) {
                saveClients();
                renderClientArchive();
                alert(`Anagrafica di "${clientName}" e relative polizze eliminate con successo.`);
            }
        }
    };

    const addNewClientInline = () => {
        if (document.getElementById('new-client-form')) {
            alert("Stai gi√† aggiungendo un nuovo cliente. Completa prima l'inserimento attuale.");
            return;
        }

        const container = document.getElementById('client-list-container');
        const newClientHTML = `
            <div class="client-item" id="new-client-form" style="border-color: var(--primary-color); border-width: 2px;">
                <div class="client-header">
                    <div class="client-info-grid">
                        <div class="client-data-fields">
                            <input type="text" id="new-nomeCliente" placeholder="Nome Cliente" required>
                            <input type="text" id="new-codiceFiscale" placeholder="CF / P.IVA">
                            <input type="tel" id="new-cellulare" placeholder="Cellulare">
                            <input type="email" id="new-email" placeholder="Email">
                            <input type="text" id="new-linkedProfiles" placeholder="Legami (es. Padre di...)" style="grid-column: 1 / -1;">
                        </div>
                        <div class="client-actions">
                            <button onclick="saveNewClientAnagrafica()" title="Salva">üíæ</button>
                            <button onclick="cancelNewClientAnagrafica()" title="Annulla">‚ùå</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('afterbegin', newClientHTML);
        document.getElementById('new-nomeCliente').focus();
    };

    const saveNewClientAnagrafica = () => {
        const newName = document.getElementById('new-nomeCliente').value.trim();
        const newCf = document.getElementById('new-codiceFiscale').value.toUpperCase().trim();
        const newCell = document.getElementById('new-cellulare').value.trim();
        const newEmail = document.getElementById('new-email').value.trim();
        const newLinks = document.getElementById('new-linkedProfiles').value.trim();

        if (!newName) {
            alert("Il campo Nome Cliente √® obbligatorio.");
            return;
        }

        if (clients.some(c => c.nomeCliente.trim().toLowerCase() === newName.toLowerCase())) {
            alert("Esiste gi√† un cliente con questo nome. Utilizzare un nome univoco.");
            return;
        }
        
        const newClientRecord = {
            id: 'id-' + Date.now(),
            nomeCliente: newName,
            codiceFiscale: newCf,
            cellulare: newCell,
            email: newEmail,
            linkedProfiles: newLinks, 
            compagnia: 'N/D',
            numeroPolizza: 'N/D',
            ramoPolizza: 'N/D',
            dataScadenza: new Date().toISOString().slice(0, 10),
            frazionamento: 'Annuale',
            premio: 0,
            pagato: false,
            dataIncasso: null,
            isAnnual: false,
            status: 'attiva',
            provvigioni: 0,
            differenza: 0
        };

        clients.push(newClientRecord);
        saveClients();
        alert(`Anagrafica per "${newName}" creata con successo!`);
        renderClientArchive();
    };

    const cancelNewClientAnagrafica = () => {
        const form = document.getElementById('new-client-form');
        if (form) form.remove();
    };
    
    const getRamoClass = (ramo) => { if (!ramo) return ''; const l = ramo.toLowerCase(); if (l.includes('auto')) return 'ramo-auto'; if (l.includes('vari')) return 'ramo-rami-vari'; if (l.includes('vita')) return 'ramo-vita'; return ''; };
    
    const toggleClientDetails = (element, clientName) => {
        const detailsContainer = element.closest('.client-header').nextElementSibling;
        if (detailsContainer.style.maxHeight) {
            detailsContainer.style.maxHeight = null;
            element.innerHTML = 'Apri Polizze ‚ñæ';
        } else {
            if (!detailsContainer.innerHTML) {
                const clientPolicies = clients.filter(c => c.nomeCliente === clientName && c.numeroPolizza !== 'N/D');
                if (clientPolicies.length === 0) {
                     detailsContainer.innerHTML = `<div style="padding: 15px; text-align: center;">Nessuna polizza trovata per questo cliente.</div>`;
                } else {
                    const policiesByNumber = clientPolicies.reduce((acc, policy) => {
                        const key = policy.numeroPolizza;
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(policy);
                        return acc;
                    }, {});

                    detailsContainer.innerHTML = Object.keys(policiesByNumber).map(policyNumber => {
                        const firstTitle = policiesByNumber[policyNumber][0];
                        const ramo = firstTitle.ramoPolizza || 'N/D';
                        const compagnia = firstTitle.compagnia || 'N/D';
                        return `
                        <div class="policy-item">
                            <div class="policy-header ${getRamoClass(ramo)}">
                                <span><strong>Polizza:</strong> ${policyNumber}</span>
                                <span><strong>Compagnia:</strong> ${compagnia}</span>
                                <span><strong>Ramo:</strong> ${ramo}</span>
                                <span>${policiesByNumber[policyNumber].length} titoli</span>
                            </div>
                            <div class="title-list">
                                ${policiesByNumber[policyNumber].sort((a,b) => new Date(a.dataScadenza) - new Date(b.dataScadenza)).map(title => `
                                    <div class="title-item">
                                        <span>Scad: ${new Date(title.dataScadenza).toLocaleDateString('it-IT')}</span>
                                        <span>Premio: ${formatPremio(title.premio)}</span>
                                        <span>Stato: ${title.status || 'attiva'}</span>
                                        <span>${title.pagato ? '‚úÖ Pagato' : '‚ùå Da Pagare'}</span>
                                        <button onclick="navigateToTitle('${title.id}')" title="Modifica Titolo">‚úèÔ∏è</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }).join('');
                }
            }
            detailsContainer.style.maxHeight = detailsContainer.scrollHeight + "px";
            element.innerHTML = 'Chiudi Polizze ‚ñ¥';
        }
    };

    const togglePolicyDetails = (element) => { const d = element.nextElementSibling; if (d.style.maxHeight) d.style.maxHeight = null; else d.style.maxHeight = d.scrollHeight + "px"; };
    const navigateToTitle = (titleId) => { showPage(mainAppPage); editClient(titleId); };
    const prepareNewTitleForClient = (clientName) => { const clientData = clients.find(c => c.nomeCliente === clientName); showPage(mainAppPage); resetForm(); if (clientData) { document.getElementById('nomeCliente').value = clientData.nomeCliente; document.getElementById('codiceFiscale').value = clientData.codiceFiscale || ''; document.getElementById('email').value = clientData.email || ''; document.getElementById('cellulare').value = clientData.cellulare || ''; } document.getElementById('form-title').scrollIntoView({ behavior: 'smooth' }); };
    //</editor-fold>
    
    //<editor-fold desc="Gestionale Polizze (Funzioni Core)">
    const formatPremio = (premio) => {
        const p = parseFloat(premio);
        if (isNaN(p) || p === 0) {
            return '<span style="color: #E67E22; font-weight: 500;">‚úé Inserire</span>';
        }
        return `${p.toFixed(2)} ‚Ç¨`;
    };

    const renderTable = () => {
        const tableBody = document.getElementById('clients-table-body');
        const filters = { year: document.getElementById('filter-year').value, month: document.getElementById('filter-month').value, incassoYear: document.getElementById('filter-incasso-year').value, incassoMonth: document.getElementById('filter-incasso-month').value, paid: document.getElementById('filter-paid').value, status: document.getElementById('filter-status').value };
        
        let filteredClients = clients.filter(client => {
            const scadenzaDate = new Date(client.dataScadenza), incassoDate = client.dataIncasso ? new Date(client.dataIncasso) : null;
            const status = client.status || 'attiva';
            return (filters.year === 'all' || scadenzaDate.getFullYear() == filters.year) && (filters.month === 'all' || (scadenzaDate.getMonth() + 1) == filters.month) && (filters.incassoYear === 'all' || (incassoDate && incassoDate.getFullYear() == filters.incassoYear)) && (filters.incassoMonth === 'all' || (incassoDate && (incassoDate.getMonth() + 1) == filters.incassoMonth)) && (filters.paid === 'all' || (filters.paid === 'paid' && client.pagato) || (filters.paid === 'unpaid' && !client.pagato)) && (filters.status === 'all' || status === filters.status);
        });

        tableBody.innerHTML = '';
        let totalPremi = 0;
        let totalProvvigioni = 0;
        
        if (filteredClients.length === 0) {
            const isMobile = window.innerWidth <= 992;
            const colspan = isMobile ? 1 : 15;
            tableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center; padding:20px;">Nessun risultato trovato.</td></tr>`;
            document.getElementById('summary').textContent = 'Totale Premi Incassati (visualizzati): 0.00 ‚Ç¨ | Totale Provvigioni Incassate (visualizzate): 0.00 ‚Ç¨';
            return;
        }

        const headers = Array.from(document.querySelectorAll('#main-app table thead th')).map(th => th.textContent);

        filteredClients.forEach(client => {
            if (client.pagato) {
                totalPremi += parseFloat(client.premio || 0);
                totalProvvigioni += parseFloat(client.provvigioni || 0);
            }
            const expStatus = getExpirationStatus(client);
            const row = document.createElement('tr'); row.className = expStatus.class;
            
            row.innerHTML = `
                <td data-label="${headers[0]}"><input type="checkbox" ${client.pagato ? 'checked' : ''} onchange="togglePaidStatus('${client.id}')"></td>
                <td data-label="${headers[1]}">${client.isAnnual ? '<span title="Scadenza Annua">‚≠ê</span>' : ''}</td>
                <td data-label="${headers[2]}">${client.nomeCliente}</td>
                <td data-label="${headers[3]}">${client.compagnia}</td>
                <td data-label="${headers[4]}">${client.numeroPolizza}</td>
                <td data-label="${headers[5]}">${client.ramoPolizza}</td>
                <td data-label="${headers[6]}">${client.tipoPolizza || ''}</td>
                <td data-label="${headers[7]}">${expStatus.text}</td>
                <td data-label="${headers[8]}" style="text-transform: capitalize;">${client.status || 'attiva'}</td>
                <td data-label="${headers[9]}">${client.frazionamento || 'Annuale'}</td>
                <td data-label="${headers[10]}">${client.dataIncasso ? new Date(client.dataIncasso).toLocaleDateString('it-IT') : '---'}</td>
                <td data-label="${headers[11]}">${formatPremio(client.premio)}</td>
                <td data-label="${headers[12]}"><input type="number" step="0.01" class="inline-editable" value="${(parseFloat(client.differenza) || 0).toFixed(2)}" onchange="updateField('${client.id}', 'differenza', this.value)"> ‚Ç¨</td>
                <td data-label="${headers[13]}"><input type="number" step="0.01" class="inline-editable" value="${(parseFloat(client.provvigioni) || 0).toFixed(2)}" onchange="updateField('${client.id}', 'provvigioni', this.value)"> ‚Ç¨</td>
                <td data-label="${headers[14]}" class="action-cell">
                    <button onclick="editClient('${client.id}')" title="Modifica">‚úèÔ∏è</button> <button onclick="deleteClient('${client.id}')" title="Elimina">üóëÔ∏è</button>
                    <select onchange="updateStatus('${client.id}', this.value)" title="Cambia Stato">
                        <option value="attiva" ${ (client.status || 'attiva') === 'attiva' ? 'selected' : ''}>Attiva</option>
                        <option value="sospesa" ${client.status === 'sospesa' ? 'selected' : ''}>Sospendi</option>
                        <option value="annullata" ${client.status === 'annullata' ? 'selected' : ''}>Annulla</option>
                    </select>
                </td>`;
            tableBody.appendChild(row);
        });
        document.getElementById('summary').textContent = `Totale Premi Incassati (visualizzati): ${totalPremi.toFixed(2)} ‚Ç¨ | Totale Provvigioni Incassate (visualizzate): ${totalProvvigioni.toFixed(2)} ‚Ç¨`;
    };
    
    const setupForm = () => { 
        document.getElementById('client-form').innerHTML = `<input type="hidden" id="clientId">
        <div class="form-field"><label>Nome Cliente</label><input type="text" id="nomeCliente" required></div>
        <div class="form-field"><label>Codice Fiscale / P.IVA</label><input type="text" id="codiceFiscale"></div>
        <div class="form-field"><label>Email</label><input type="email" id="email"></div>
        <div class="form-field"><label>Cellulare</label><input type="tel" id="cellulare"></div>
        <div class="form-field"><label>Compagnia</label><select id="compagnia" required><option value="" disabled selected>-- Seleziona --</option><option>Allianz</option><option>HDI</option><option>Vittoria</option><option>ARAG</option><option>Helvetia</option><option>Genialpiu'</option><option>Metlife</option><option>Broker</option><option>Altro</option></select><input type="text" id="compagniaAltro" placeholder="Altra compagnia" style="display:none;margin-top:5px;"></div>
        <div class="form-field"><label>Numero Polizza</label><input type="text" id="numeroPolizza" required></div>
        <div class="form-field"><label>Ramo Polizza</label><select id="ramoPolizza" required><option>Auto</option><option>Rami Vari</option><option>Vita</option></select></div>
        <div class="form-field"><label>Tipo Polizza</label><input type="text" id="tipoPolizza"></div>
        <div class="form-field"><label>Data Decorrenza</label><input type="date" id="dataScadenza" required></div>
        <div class="form-field"><label>Frazionamento</label><select id="frazionamento"><option>Annuale</option><option>Semestrale</option><option>Quadrimestrale</option><option>Trimestrale</option><option>Mensile con SDD</option><option>Temporanea</option><option>Premio Unico</option><option>Annullamento</option></select></div>
        <div class="form-field"><label>Premio in ‚Ç¨</label><input type="number" step="0.01" id="premio"></div>
        <div class="form-field" id="dataIncassoContainer" style="display:none;"><label for="dataIncasso">Data Incasso</label><input type="date" id="dataIncasso"></div>
        <div class="form-checkbox"><input type="checkbox" id="pagato" onchange="toggleDataIncasso(this.checked)"><label for="pagato">Pagato</label></div>
        <div class="form-checkbox"><input type="checkbox" id="isAnnual"><label for="isAnnual">Scadenza Annua</label></div>
        <button type="submit" class="form-submit-button" id="submit-button">Aggiungi Titolo</button>`; 
        
        const c=new Date().getFullYear();
        ['filter-year','filter-incasso-year'].forEach(id=>{
            const s=document.getElementById(id);
            s.innerHTML='<option value="all">Anno</option>';
            for(let i=c-5;i<=c+5;i++)s.innerHTML+=`<option value="${i}">${i}</option>`;
        });
        const m=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        ['filter-month','filter-incasso-month'].forEach(id=>{
            const s=document.getElementById(id);
            s.innerHTML='<option value="all">Mese</option>';
            m.forEach((n,i)=>s.innerHTML+=`<option value="${i+1}">${n}</option>`);
        }); 
    };
    
    const addOrUpdateClient = e => { 
        e.preventDefault(); 
        const d = { 
            id: document.getElementById('clientId').value, 
            nomeCliente: document.getElementById('nomeCliente').value, 
            codiceFiscale: document.getElementById('codiceFiscale').value.toUpperCase(), 
            email: document.getElementById('email').value, 
            cellulare: document.getElementById('cellulare').value, 
            compagnia: document.getElementById('compagnia').value === 'Altro' ? document.getElementById('compagniaAltro').value : document.getElementById('compagnia').value, 
            numeroPolizza: document.getElementById('numeroPolizza').value, 
            ramoPolizza: document.getElementById('ramoPolizza').value, 
            tipoPolizza: document.getElementById('tipoPolizza').value, 
            dataScadenza: document.getElementById('dataScadenza').value, 
            frazionamento: document.getElementById('frazionamento').value, 
            premio: parseFloat(document.getElementById('premio').value) || 0, 
            pagato: document.getElementById('pagato').checked, 
            dataIncasso: document.getElementById('pagato').checked ? document.getElementById('dataIncasso').value : null, 
            isAnnual: document.getElementById('isAnnual').checked, 
            status: 'attiva' 
        }; 

        if (d.id) {
            const i = clients.findIndex(c => c.id === d.id);
            const oldRecord = { ...clients[i] };
            d.status = clients[i].status || 'attiva'; 
            clients[i] = { ...clients[i], ...d };

            const rateFrazionamenti = ['Semestrale', 'Quadrimestrale', 'Trimestrale'];
            if (rateFrazionamenti.includes(d.frazionamento) && oldRecord.premio !== d.premio) {
                clients.forEach(targetClient => {
                    if (
                        targetClient.id !== d.id && 
                        targetClient.numeroPolizza === d.numeroPolizza &&
                        !targetClient.isAnnual
                    ) {
                        const timeDiff = Math.abs(new Date(d.dataScadenza) - new Date(targetClient.dataScadenza));
                        const daysDiff = timeDiff / (1000 * 3600 * 24);
                        if (daysDiff < 360) {
                           targetClient.premio = d.premio;
                        }
                    }
                });
            }

        } else { 
            d.id = 'id-' + Date.now(); 
            d.provvigioni = 0; 
            const cD = new Date(d.dataScadenza); 
            const pY = clients.find(p => p.nomeCliente.trim().toLowerCase() === d.nomeCliente.trim().toLowerCase() && p.ramoPolizza.trim().toLowerCase() === d.ramoPolizza.trim().toLowerCase() && new Date(p.dataScadenza).getFullYear() === (cD.getFullYear() - 1)); 
            d.differenza = pY ? (d.premio - pY.premio) : 0; 
            clients.push(d); 
            if (d.isAnnual && d.frazionamento !== 'Annuale') generateInstallments(d); 
        } 
        resetForm(); 
        saveClients(); 
        renderTable(); 
    };

    const editClient = (id) => { const c = clients.find(cl => cl.id === id); if (!c) return; document.getElementById('clientId').value = c.id; document.getElementById('nomeCliente').value = c.nomeCliente; document.getElementById('codiceFiscale').value = c.codiceFiscale || ''; document.getElementById('email').value = c.email || ''; document.getElementById('cellulare').value = c.cellulare || ''; document.getElementById('numeroPolizza').value = c.numeroPolizza; document.getElementById('ramoPolizza').value = c.ramoPolizza; document.getElementById('tipoPolizza').value = c.tipoPolizza || ''; document.getElementById('dataScadenza').value = c.dataScadenza; document.getElementById('frazionamento').value = c.frazionamento; document.getElementById('premio').value = c.premio; document.getElementById('pagato').checked = c.pagato; document.getElementById('isAnnual').checked = c.isAnnual; toggleDataIncasso(c.pagato); if (c.pagato) document.getElementById('dataIncasso').value = c.dataIncasso; const comp = document.getElementById('compagnia'), altro = document.getElementById('compagniaAltro'); const isStd = [...comp.options].some(opt => opt.value === c.compagnia); comp.value = isStd ? c.compagnia : 'Altro'; altro.style.display = isStd ? 'none' : 'block'; altro.value = isStd ? '' : c.compagnia; document.getElementById('form-title').textContent = 'Modifica Titolo'; document.getElementById('submit-button').textContent = 'Salva Modifiche'; document.getElementById('form-title').scrollIntoView({ behavior: 'smooth' }); };
    const importFromJson = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { try { const d = JSON.parse(ev.target.result); if (!Array.isArray(d)) throw new Error("File non valido."); if (confirm("ATTENZIONE: Sovrascrivere i dati attuali? I dati verranno salvati su Firebase.")) { clients = d; saveClients(); alert("Dati importati e salvati su Firebase! Verranno visualizzati a breve."); renderTable(); renderClientArchive(); } } catch (err) { alert("Errore: File non valido o corrotto."); } e.target.value = ''; }; r.readAsText(f); };
    
    const saveClients = () => {
        if (currentUser) {
            const userDocRef = db.collection('clienti').doc(currentUser.uid);
            userDocRef.set({ data: JSON.stringify(clients) })
                .then(() => console.log("Backup su Firebase riuscito!"))
                .catch(error => {
                    console.error("Errore nel backup su Firebase: ", error);
                    alert("ATTENZIONE: Salvataggio su Cloud fallito.");
                });
        } else {
            console.warn("Nessun utente loggato, salvataggio ignorato.");
        }
    };
    
    const toggleDataIncasso = (p) => { const c=document.getElementById('dataIncassoContainer'),i=document.getElementById('dataIncasso');c.style.display=p?'block':'none';i.required=p;if(p&&!i.value)i.value=new Date().toISOString().slice(0,10);};
    const generateInstallments = (p)=>{const m={'Semestrale':6,'Quadrimestrale':4,'Trimestrale':3},inc=m[p.frazionamento];if(!inc)return;let count=12/inc-1;for(let i=1;i<=count;i++){const inst={...p},sD=new Date(p.dataScadenza),nD=new Date(sD.setMonth(sD.getMonth()+(inc*i)));inst.id='id-'+Date.now()+i;inst.dataScadenza=nD.toISOString().slice(0,10);inst.isAnnual=false;inst.pagato=false;inst.dataIncasso=null;inst.differenza=0;inst.provvigioni=0;clients.push(inst);}};
    
    const updateStatus = (id, newStatus) => {
        const recordIndex = clients.findIndex(c => c.id === id);
        if (recordIndex === -1) return;

        const originalRecord = clients[recordIndex];

        if (newStatus === 'sospesa') {
            const suspensionDateStr = prompt("Inserisci la data di SOSPENSIONE (formato AAAA-MM-GG):");
            if (!suspensionDateStr) { renderTable(); return; }
            
            const suspensionDate = new Date(suspensionDateStr);
            if (isNaN(suspensionDate.getTime())) {
                alert("Data di sospensione non valida. L'operazione √® stata annullata.");
                renderTable(); return;
            }

            const reactivationDateStr = prompt("Inserisci la data di RIATTIVAZIONE (formato AAAA-MM-GG):");
            if (!reactivationDateStr) { renderTable(); return; }

            const reactivationDate = new Date(reactivationDateStr);
            if (isNaN(reactivationDate.getTime())) {
                alert("Data di riattivazione non valida. L'operazione √® stata annullata.");
                renderTable(); return;
            }

            if (reactivationDate <= suspensionDate) {
                alert("La data di riattivazione deve essere successiva a quella di sospensione. L'operazione √® stata annullata.");
                renderTable(); return;
            }

            const durationMs = reactivationDate.getTime() - suspensionDate.getTime();

            clients.forEach(client => {
                if (client.numeroPolizza === originalRecord.numeroPolizza && new Date(client.dataScadenza) >= suspensionDate) {
                    const oldDueDate = new Date(client.dataScadenza);
                    const newDueDate = new Date(oldDueDate.getTime() + durationMs);
                    client.dataScadenza = newDueDate.toISOString().slice(0, 10);
                    client.status = 'attiva'; 
                }
            });

            alert("Scadenze aggiornate con successo in base al periodo di sospensione.");
            saveClients();
            renderTable();
        } else {
            originalRecord.status = newStatus;
            saveClients();
            renderTable();
        }
    };

    const togglePaidStatus=(id)=>{const i=clients.findIndex(c=>c.id===id);if(i!==-1){clients[i].pagato=!clients[i].pagato;clients[i].dataIncasso=clients[i].pagato?(clients[i].dataIncasso||new Date().toISOString().slice(0,10)):null;saveClients();renderTable();}};
    
    const updateField=(id,f,v)=>{
        const index = clients.findIndex(c=>c.id===id);
        if(index !== -1){
            const updatedValue = (f==='differenza'||f==='provvigioni') ? parseFloat(v) || 0 : v;
            clients[index][f] = updatedValue;

            if (f === 'provvigioni') {
                const updatedRecord = clients[index];
                if (!updatedRecord.isAnnual) {
                    const currentDate = new Date(updatedRecord.dataScadenza);
                    clients.forEach(targetClient => {
                        if (
                            targetClient.id !== id &&
                            targetClient.numeroPolizza === updatedRecord.numeroPolizza &&
                            !targetClient.isAnnual &&
                            new Date(targetClient.dataScadenza) > currentDate 
                        ) {
                           targetClient.provvigioni = updatedValue;
                        }
                    });
                }
            }

            saveClients();
            renderTable();
        }
    };

    const deleteClient=(id)=>{if(confirm('Eliminare questo titolo?')){clients=clients.filter(c=>c.id!==id);saveClients();renderTable();}};
    const resetForm=()=>{document.getElementById('client-form').reset();document.getElementById('clientId').value='';document.getElementById('compagniaAltro').style.display='none';toggleDataIncasso(false);document.getElementById('form-title').textContent='Aggiungi Titolo';document.getElementById('submit-button').textContent='Aggiungi Titolo';};
    
    const sortClientsByDate=()=>{
        isSortedAsc=!isSortedAsc;
        clients.sort((a,b)=>isSortedAsc?new Date(a.dataScadenza)-new Date(b.dataScadenza):new Date(b.dataScadenza)-new Date(a.dataScadenza));
        renderTable();
    };

    const exportToJson=()=>{if(clients.length===0){alert("Nessun dato da esportare.");return}const d=clients,s=JSON.stringify(d,null,2),b=new Blob([s],{type:"application/json"}),u=URL.createObjectURL(b),l=document.createElement('a');l.download=`backup_clienti_${new Date().toISOString().slice(0,10)}.json`;l.href=u;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(u);alert("Backup locale esportato!")};
    
    const createRenewals=()=>{
        const y=new Date().getFullYear(),r=prompt("Anno di riferimento:",y);
        if(!r||isNaN(r))return;
        const t=parseInt(r)+1;
        if(!confirm(`Creare rinnovi per ${t} da polizze annuali del ${r}?`))return;
        
        const excludedFraz = ['Temporanea', 'Premio Unico', 'Annullamento'];
        // MODIFICA CORRETTA: Aggiunto controllo per c.status !== 'annullata'
        const p=clients.filter(c=>
            c.isAnnual && 
            new Date(c.dataScadenza).getFullYear()==r && 
            !excludedFraz.includes(c.frazionamento) &&
            c.status !== 'annullata'
        );
        
        if(p.length===0){alert(`Nessuna polizza annuale attiva trovata per ${r} da rinnovare.`);return}
        let n=0;
        p.forEach(o=>{
            const d=new Date(o.dataScadenza),e=new Date(d.setFullYear(d.getFullYear()+1)),x=clients.some(c=>c.numeroPolizza===o.numeroPolizza&&new Date(c.dataScadenza).getFullYear()===t);
            if(!x){
                const w={...o};
                w.id='id-'+Date.now()+Math.random();
                w.dataScadenza=e.toISOString().slice(0,10);
                w.premio=0;
                w.pagato=false;
                w.dataIncasso=null;
                w.differenza=0;
                w.provvigioni=0;
                w.status='attiva';
                clients.push(w);
                n++
            }
        });
        if(n>0){saveClients();renderTable();alert(`${n} rinnovi creati per ${t}.`)}else alert(`Nessun nuovo rinnovo da creare per ${t}.`)
    };

    const printCustom = () => {
        const header = document.getElementById('print-header');
        const monthSelect = document.getElementById('filter-incasso-month');
        const yearSelect = document.getElementById('filter-incasso-year');
        const monthValue = monthSelect.value;
        const yearValue = yearSelect.value;
        const monthText = monthValue === 'all' ? '' : monthSelect.options[monthSelect.selectedIndex].text;
        const yearText = yearValue === 'all' ? '' : yearValue;
        let title = "Incassi";
        if (monthText && yearText) {
            title += ` ${monthText} ${yearText}`;
        } else if (monthText) {
            title += ` ${monthText}`;
        } else if (yearText) {
            title += ` ${yearText}`;
        } else {
            title += " (Tutti)";
        }
        header.textContent = title;
        window.print();
    };

    const getBirthdayFromCF=(cf)=>{if(!cf||cf.length<15)return null;try{const y=cf.substring(6,8),m=cf.substring(8,9).toUpperCase();let d=parseInt(cf.substring(9,11));if(d>40)d-=40;const c=Math.floor(new Date().getFullYear()/100);let Y=parseInt(y);Y=Y>(new Date().getFullYear()%100)?(c-1)*100+Y:c*100+Y;const M={'A':0,'B':1,'C':2,'D':3,'E':4,'H':5,'L':6,'M':7,'P':8,'R':9,'S':10,'T':11}[m];if(isNaN(d)||isNaN(Y)||M===undefined)return null;const b=new Date(Y,M,d);if(b.getFullYear()!==Y||b.getMonth()!==M||b.getDate()!==d)return null;return b}catch(e){return null}};
    
    const renderBirthdayNotifications = () => {
        const container = document.getElementById('birthday-notifications');
        const today = new Date();
        const todayKey = 'sentGreetings_' + today.toISOString().slice(0, 10);
        const sentToday = JSON.parse(localStorage.getItem(todayKey)) || [];

        const birthdayClientsToday = clients.filter(client => {
            if (sentToday.includes(client.id)) {
                return false;
            }
            if (!client.codiceFiscale) return false;
            const birthDate = getBirthdayFromCF(client.codiceFiscale);
            return birthDate && birthDate.getMonth() === today.getMonth() && birthDate.getDate() === today.getDate();
        });

        const uniqueBirthdays = new Map();
        birthdayClientsToday.forEach(client => {
            if (client.codiceFiscale) {
                uniqueBirthdays.set(client.codiceFiscale, client);
            }
        });

        const birthdaysToShow = Array.from(uniqueBirthdays.values());

        if (birthdaysToShow.length === 0) {
            container.style.display = 'none';
        } else {
            container.style.display = 'block';
            let html = `<h4>üéÇ Compleanni di Oggi</h4>`;
            birthdaysToShow.forEach(client => {
                html += `<div class="birthday-item" id="bday-${client.id}"><span>${client.nomeCliente}</span><button onclick="sendBirthdayGreeting('${client.id}')">Invia Auguri</button></div>`;
            });
            container.innerHTML = html;
        }
    };

    const markGreetingAsSent = (clientId) => {
        const todayKey = 'sentGreetings_' + new Date().toISOString().slice(0, 10);
        let sentToday = JSON.parse(localStorage.getItem(todayKey)) || [];
        if (!sentToday.includes(clientId)) {
            sentToday.push(clientId);
            localStorage.setItem(todayKey, JSON.stringify(sentToday));
        }
        renderBirthdayNotifications();
    };

    const getExpirationStatus=(c)=>{const d=new Date(c.dataScadenza),s=d.toLocaleDateString('it-IT');if(c.status==='annullata')return{class:'status-annullata',text:s};if(c.status==='sospesa')return{class:'status-suspended',text:`‚è∏Ô∏è ${s}`};if(c.pagato)return{class:'status-paid',text:s};const o=new Date();o.setHours(0,0,0,0);const g=c.compagnia&&c.compagnia.toLowerCase()==='vittoria'?30:15,f=new Date(d);f.setDate(f.getDate()+g);if(o>f)return{class:'status-danger',text:`Scaduta (${s})`};const a=Math.round((d-o)/864e5);if(o>d)return{class:'status-danger',text:`In mora (-${Math.abs(a)}gg)`};if(a<=15)return{class:'status-warning',text:`In scadenza (+${a}gg)`};return{class:'',text:s}};
    const sendEmailGreeting=(c)=>{const m=`Gentile ${c.nomeCliente},\n\nLe porgiamo i nostri pi√π sinceri auguri.\n\nSaluti.`,s="Buon Compleanno!";window.location.href=`mailto:${c.email}?subject=${encodeURIComponent(s)}&body=${encodeURIComponent(m)}`};
    const sendWhatsappGreeting=(c)=>{const m=`Gentile ${c.nomeCliente},\n\nLe porgiamo i nostri pi√π sinceri auguri.\n\nSaluti.`;let p=c.cellulare.replace(/[^0-9+]/g,'');if(!p.startsWith('+'))p='39'+p.replace(/^0+/,'');window.open(`https://web.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(m)}`,'_blank')};
    
    const sendBirthdayGreeting=(id)=>{
        const c=clients.find(l=>l.id===id);
        if(!c) return;
        
        const h=c.email&&c.email.includes('@');
        const p=c.cellulare&&/^\+?[0-9\s-]{7,}$/.test(c.cellulare);
        
        if(h&&p){
            const m=document.getElementById('choice-modal');
            m.style.display='flex';
            m.dataset.clientId=id;
        } else if(h) {
            sendEmailGreeting(c);
            markGreetingAsSent(id);
        } else if(p) {
            sendWhatsappGreeting(c);
            markGreetingAsSent(id);
        } else {
            alert("Nessun contatto (email/cellulare) valido per inviare gli auguri.");
        }
    };
    //</editor-fold>

    document.addEventListener('DOMContentLoaded', () => {
        setupForm();

        document.getElementById('goto-main-app').addEventListener('click', () => {
            showPage(mainAppPage);
            const d = new Date();
            document.getElementById('filter-month').value = d.getMonth() + 1;
            document.getElementById('filter-year').value = d.getFullYear();
            
            clients.sort((a, b) => new Date(a.dataScadenza) - new Date(b.dataScadenza));
            isSortedAsc = true;
            
            renderTable();
        });

        document.getElementById('goto-client-archive').addEventListener('click', () => { showPage(clientArchivePage); renderClientArchive(); });
        document.getElementById('back-to-landing-1').addEventListener('click', () => showPage(landingPage));
        document.getElementById('back-to-landing-2').addEventListener('click', () => showPage(landingPage));
        
        const importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFile = document.getElementById('import-file');
        exportBtn.addEventListener('click', exportToJson);
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', importFromJson);
        
        document.getElementById('client-form').addEventListener('submit', addOrUpdateClient);
        ['filter-year','filter-month','filter-incasso-year','filter-incasso-month','filter-paid','filter-status'].forEach(id=>document.getElementById(id).addEventListener('change',renderTable));
        document.getElementById('sort-button').addEventListener('click', sortClientsByDate);
        document.getElementById('compagnia').addEventListener('change', e=>document.getElementById('compagniaAltro').style.display=e.target.value==='Altro'?'block':'none');
        document.getElementById('renew-btn').addEventListener('click', createRenewals);
        
        document.getElementById('add-new-client-btn').addEventListener('click', addNewClientInline);
        
        document.getElementById('apply-client-filter-btn').addEventListener('click', renderClientArchive);
        document.getElementById('search-name').addEventListener('keyup', (e) => { if (e.key === 'Enter') renderClientArchive(); });
        document.getElementById('search-cf').addEventListener('keyup', (e) => { if (e.key === 'Enter') renderClientArchive(); });
        
        const modal = document.getElementById('choice-modal');
        document.getElementById('modal-btn-email').addEventListener('click', () => { 
            const id = modal.dataset.clientId; 
            if (id) {
                sendEmailGreeting(clients.find(c => c.id === id));
                markGreetingAsSent(id); 
            }
            modal.style.display = 'none';
        });
        document.getElementById('modal-btn-whatsapp').addEventListener('click', () => { 
            const id = modal.dataset.clientId; 
            if (id) {
                sendWhatsappGreeting(clients.find(c => c.id === id));
                markGreetingAsSent(id);
            }
            modal.style.display = 'none';
        });
        document.getElementById('modal-btn-cancel').addEventListener('click', () => modal.style.display = 'none');
        
        document.getElementById('calculate-cf-btn').addEventListener('click', calculateCF);
        document.getElementById('reverse-cf-btn').addEventListener('click', reverseCF);
        document.getElementById('cf-copy-btn').addEventListener('click', copyCF);
        const tabCalc = document.getElementById('tab-btn-calc'), tabRev = document.getElementById('tab-btn-rev');
        const panelCalc = document.getElementById('cf-calc-panel'), panelRev = document.getElementById('cf-rev-panel');
        tabCalc.addEventListener('click', () => {
            tabCalc.classList.add('active'); tabRev.classList.remove('active');
            panelCalc.classList.add('active'); panelRev.classList.remove('active');
        });
        tabRev.addEventListener('click', () => {
            tabRev.classList.add('active'); tabCalc.classList.remove('active');
            panelRev.classList.add('active'); panelCalc.classList.remove('active');
        });

        loadComuni();
    });
</script>
</body>
</html>
